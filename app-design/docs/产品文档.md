# P2P 直连文件发送应用 - 产品可行性与交互文档

## 1. 核心需求剖析
本产品的核心目标是降低设备间文件传输的壁垒。核心需求如下：
- **发送方（角色 A）**：打开 Web 应用后自动或手动生成专属“邀请码”。可选择单个或多个文件，等待接收方连接后发送。
- **接收方（角色 B）**：通过同款应用输入“邀请码”，与 A 建立端到端直连，并接收文件。
- **断连处理**：在由于网络波动、切换 Wi-Fi/5G 等原因导致直连断开时，系统必须提供交互良好的断连感知，并支持在重连后接力续传（断点续传）已中断的文件。

## 2. 竞品及开源项目调研
此类需求在市场上已有经过验证的开源实现与商业级产品：
1. **Snapdrop / PairDrop**
   - 机制：利用本地局域网（LAN）或 WebRTC 实现近场/广域网发现与传输。
   - 交互：打开网页即自动发现局域网内的设备，但基于“邀请码”跨网段穿透连接的机制相对薄弱。
2. **ShareDrop**
   - 机制：HTML5 WebRTC 的克隆版 Apple AirDrop。可通过特定的分享链接实现跨网络传输。
3. **WebTorrent**
   - 机制：浏览器端的 BitTorrent 客户端。其强项在于多点并发分发，也可作为 P2P 发送的底层参考协议。
4. **LocalSend**
   - 机制：局域网传输神器，跨平台的系统级应用，非纯 Web App。

**结论**：在纯 Web 端通过输入邀请码进行 1对1 直连并发送文件的模式技术极其成熟。我们将在此基础上，结合“断点续传”交互，打造更具韧性的产品体验。

## 3. 产品可行性分析
- **技术成熟度**：极高。现代主流浏览器（Chrome, Firefox, Safari, Edge）已全面原生支持 `WebRTC API`（负责 P2P 打洞与数据传输通道搭建）和 HTML5 `File API`（负责大文件在浏览器端的切片读取），**完全可以在不借助服务端做数据中转的前提下实现高速传输。**
- **隐私与安全**：数据在浏览器间双向端到端加密（DTLS/SRTP），服务器仅作为“介绍人”交换网络位置信息，不碰触任何用户文件数据。
- **运维成本**：极低。由于文件流量不走中心化服务器，整个架构的服务器带宽负荷可以忽略不计，仅需维护极轻量的信令系统。

## 4. 核心交互流程设计

### 4.1. 主线交互（正常连接与传输）
1. **角色 A 准备**：
   - 打开主页，应用向其分配全局唯一的身份（如：`Peer-A`）。
   - 界面显著位置生成六位极简“邀请码”（如 `782914`）以及快捷分享功能（二维码/分享链接）。
   - 状态显示：“正在等待接收方接入...”。
2. **角色 B 接入**：
   - 打开主页，在显眼的接收框内输入 `782914`。
   - 界面提示：“正在与发送方建立安全直连...”。
3. **直连握手与发送**：
   - 底层 P2P 通道打通。A 和 B 的界面同时进入“连接已建立”状态，显示对方设备的脱敏代号（如 `MacBook-Chrome`）。
   - A 点击“➕添加文件”或将文件拖入发送区。
   - 发送开始。双方界面展示统一的传输任务列表，包含文件名称、实时网速（如 `25MB/s`）、进度条及剩余时间预估。
4. **传输完成**：
   - 进度达到 100%。B 的浏览器自动触发大文件的合并与下载保存。页面弹出“🎉 传输成功”反馈。

### 4.2. 异常交互（断连与断点续传核心逻辑）
在复杂的网络环境下（如移动设备息屏、网络切换），WebRTC 通道可能断开。
1. **断连感知层**：
   - 一旦底层 `ICE connection state` 触发 `disconnected` 或 `failed`，双方界面立即将进行中的任务置为「暂停/异常」状态，并飘红提示“网络连接已断开”。
   - 进度条锁在断点处（比如 `56%`）。
2. **重连协商**：
   - 接收方 B 页面提供【尝试重连】按钮，或者通过 `localStorage` 自动在后台尝试通过同样的邀请码找回 A。
   - 一旦通过信令服务器重新寻找到 A，双方自动发起新一轮 WebRTC P2P 握手。
3. **断点状态恢复与续传（业务核心）**：
   - 重连成功后，B（接收者）在内存中统计该文件目前已完整收到的“切片索引（Chunk IDs）”，并将其汇总为一张「进度清单」发送给 A（发送方）。
   - A 的应用接收到清单后，比对本地文件，UI 提示 A：“对方已重新连接。是否从 56% 处继续发送《视频.mp4》？”
   - A 确认【继续】。底层只读取未发送的部分数据切片，继续通过 DataChannel 灌入。
   - 双端恢复正常的传输进度条状态，直到满血复活完成。
