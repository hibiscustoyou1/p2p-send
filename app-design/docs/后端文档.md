# P2P 直连文件发送应用 - 后端可行性分析与实现方案

## 1. 结论摘要
后端专家结论为：**本项目中，后端的定位非常明确且轻巧。它是去中心化 P2P 网络的“中心调度站”与“红娘”。**
此项目后端落地的难度属于初级偏上，可行性 100%。后端的重心并非耗费在繁重的业务逻辑编排和数据库锁机制控制上，而是如何提供一个**极高响应速度、极低延迟并保证绝对高并发横向扩展能力的 WebSocket 信令网桥**。

## 2. 核心挑战与应对策略

### 2.1 状态管理与房间分配机制 (Room Matching)
应用需要靠 6位数字邀请码 来精准配对浏览器 A 与 B。
- **设计思路**：信令服务需要以高并发安全的结构维护一个全局的会话表。利用 Node.js 原生的非阻塞特点和 `Socket.io` 自带的 `Rooms` 频道管理功能能够极其轻松地实现这点。
- **生命周期策略**：
  当 A 连入时，服务端生成短码（通过类似 `nanoid` 或者六位随机数配比，需检测唯一碰撞冲突），创建一个 Socket 频道，名称即为该短码，并让 A 的长链接放入该房间待命。
  当 B 依靠输入对应短码连入后，校验房间是否存在且容量未满（强制上限限制为仅允许 2 个人在该房间内）。
  若 B 验证入房成功，立即双向广播配对成功的握手唤醒信号，拉开 SDP 交换的大幕。

### 2.2 无状态网络服务的高可用延展难题
虽然短期内单点 Node.js 服务实例可以游刃有余地承载数万人同时发起握手信令的需求（因为握手完成后网络隧道就抛开底层服务走了），但如果要考虑企业级高可用冗余或容灾横向扩容（多 Pod 部署）：
- **我们的解法**：基于 `Socket.io-Redis-Adapter` 将内存中孤立的会话频道分布下沉到 Redis 集群进行同步投递推送。这样一来，即便是 Client A 短链接到 Server 01，Client B 由于负载均衡落在了 Server 02，他们照样能透过同级别的邀请代码由于 Redis Pub/Sub 订阅顺利握手配对。

### 2.3 ICE / TURN 兜底成本的考量
在国内，中国移动/联通/电信 等复杂的城域网层层 NAT，可能导致有 20-30% 的概率，两个浏览器死活“打洞直连”不成功。此时如果不配置 TURN 服务器，则意味着连接彻底失败流产，影响软件口碑。
- **我们的解法**：
  服务端模块的 `apps/server` 除了需要启动 Node.js 信令，还必须给出如何统一部署诸如开源的 `coturn` 服务器的基础架构运维指导编排文件（Dockerfile/Docker Compose），为系统兜底中转数据的配置提供一键化操作。后端 API 会在用户刚刚请求 WebSocket 之前，提供接口下发临时、动态生成包含签名校验的 TURN credentials (账户密码凭证组)，防止公网白嫖你的高昂带宽服务器。

## 3. 对当前框架的对接计划
现有项目的 `apps/server` (Express) 框架极度适配此场景：
1. 我们只需在 `apps/server` 的现存入口处绑定 `ws` / `socket.io`。
2. 在 `packages/shared` 里枚举好前后端所有交互所需的 WebSocket 握手契约事件字符串以及类型（类似 `ClientToServerEvents`, `ServerToClientEvents`）。
3. 数据库（Prisma）层面甚至可以直接不用！因为作为纯粹的文件传输工具，如果我们不打算保留用户的注册信息与历史流水账本持久化日志，可以直接无盘无库内存空转执行；如果后续要搞付费版或记录传输频次量等商业特性，则非常轻易就可以把打点日志存入已经组装好的 Prisma ORM Schema 之中。
